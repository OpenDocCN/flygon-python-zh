# 第三章：设置网络实验室环境

我们现在已经有了如何编写和开发 Python 脚本的基本概念，这是创建程序的基本组成部分。我们现在将继续了解为什么自动化是当今网络中一个重要的话题，然后我们将使用一种流行的软件之一，名为 EVE-NG，来构建我们的网络自动化实验室，这有助于我们虚拟化网络设备。

在本章中，我们将涵盖以下主题：

+   何时以及为什么自动化网络

+   屏幕抓取与 API 自动化

+   为什么要使用 Python 进行网络自动化

+   网络自动化的未来

+   实验室设置

+   准备工作：安装 EVE-NG

+   构建企业网络拓扑

# 技术要求

在本章中，我们将介绍 EVE-NG 的安装步骤以及如何创建我们的实验室环境。安装将在 VMware Workstation、VMware ESXi 和最后的 Red Hat KVM 上进行，因此您应该熟悉虚拟化概念，并在实验室设置之前已经运行其中一个 hypervisor。

# 何时以及为什么自动化网络

网络自动化正在全球范围内增加。然而，了解何时以及为什么自动化您的网络是非常重要的。例如，如果您是几个网络设备（三四个交换机）的管理员，并且不经常在它们上执行许多任务，那么您可能不需要对它们进行全面自动化。实际上，编写和开发脚本以及测试和故障排除所需的时间可能大于手动执行简单任务所需的时间。另一方面，如果您负责一个包含多供应商平台的大型企业网络，并且经常执行重复任务，那么强烈建议您编写脚本来自动化。

# 我们为什么需要自动化？

今天网络自动化的重要性有几个原因：

+   **降低成本**：使用自动化解决方案（无论是内部开发还是从供应商购买）将减少网络操作复杂性以及配置、操作网络设备所需的时间

+   **业务连续性**：自动化将减少当前基础设施上服务创建过程中的人为错误，从而使企业能够缩短服务的**上市时间**（**TTM**）

+   **业务敏捷性**：大多数网络任务都是重复的，通过自动化，您将提高生产力并推动业务创新

+   **相关性**：建立稳固的自动化工作流程使网络和系统管理员能够更快地进行根本原因分析，并增加通过将多个事件相关联来解决问题的可能性

# 屏幕抓取与 API 自动化

长期以来，CLI 是管理和操作网络设备的唯一访问方法。运营商和管理员过去通常使用 SSH 和 Telnet 来访问网络终端进行配置和故障排除。Python 或任何编程语言在与设备通信时有两种方法。第一种是像以前一样使用 SSH 或 Telnet 获取信息，然后处理它。这种方法称为**屏幕抓取**，需要能够与设备建立连接并直接在终端上执行命令的库，以及其他库来处理返回的信息，以提取有用的数据。这种方法通常需要了解其他解析语言，如正则表达式，以匹配输出的数据模式并从中提取有用的数据。

第二种方法称为**应用程序可编程接口**（**API**），这种方法完全依赖于使用 REST 或 SOAP 协议向设备发送结构化请求，并返回输出，也以结构化格式编码为 JSON 或 XML。与第一种方法相比，这种方法中处理返回数据所需的时间相当短；但是，API 需要在网络设备上进行额外的配置以支持它。

# 为什么要使用 Python 进行网络自动化？

Python 是当今一个非常结构良好且易于使用的编程语言，面向技术、Web 和互联网开发、数据挖掘和可视化、桌面 GUI、分析、游戏开发和自动化测试的许多领域；这就是为什么它被称为*通用目的语言*。

因此，选择 Python 有三个原因：

+   易读性和易用性：当你使用 Python 进行开发时，实际上是在用英语写作。Python 内部的许多关键字和程序流都被设计成可读的语句。此外，Python 不需要`;`或花括号来开始和结束代码块，这使得 Python 具有较低的学习曲线。最后，Python 有一些可选的规则，称为 PEP 8，告诉 Python 开发人员如何格式化他们的程序以获得可读的代码。

你可以配置 PyCharm 来遵循这些规则，并通过转到设置|检查|PEP 8 编码风格违规来检查你的代码是否违反了这些规则：

![](img/00041.jpeg)

+   **库**：这是 Python 的真正力量：库和包。Python 在许多领域拥有广泛的库。任何 Python 开发人员都可以轻松开发一个 Python 库并将其上传到网上，以便其他开发人员使用。库被上传到一个名为 PyPI 的网站（[`pypi.Python.org/pypi`](https://pypi.python.org/pypi)），并链接到一个 GitHub 存储库。当你想要将库下载到你的电脑上时，你可以使用一个叫做`pip`的工具连接到 PyPI 并将其下载到本地。诸如思科、Juniper 和 Arista 等网络供应商开发了库来方便访问他们的平台。大多数供应商都在努力使他们的库易于使用，并且需要最少的安装和配置步骤来从设备中检索有用的信息。

+   **强大**：Python 试图最小化达到最终结果所需的步骤数量。例如，要使用 Java 打印 hello world，你将需要这个代码块：

![](img/00042.jpeg)

然而，在 Python 中，整个代码块都写在一行中以打印它，如下面的屏幕截图所示：

![](img/00043.jpeg)

将所有这些原因结合在一起，使 Python 成为自动化的事实标准，也是供应商在自动化网络设备时的首选。

# 网络自动化的未来

在很长一段时间里，网络自动化只意味着使用编程语言（如 Perl、TcL 或 Python）开发脚本，以便在不同的网络平台上执行任务。这种方法被称为**脚本驱动的网络自动化**。但随着网络变得更加复杂和服务导向，需要并开始出现新类型的自动化，例如以下内容：

+   **软件定义的网络自动化**：网络设备只有一个转发平面，而控制平面是使用外部软件（称为**SDN 控制器**）实现和创建的。这种方法的好处是任何网络变化都将有一个单一的联系点，并且 SDN 控制器可以接受来自其他软件（如外部门户）的变更请求，通过良好实现的北向接口。

+   **高级编排**：这种方法需要一个称为编排器的软件，它与 SDN 控制器集成，并使用抽象服务的语言（如 YANG）创建网络服务模型，该模型将在其上运行的底层设备中运行。此外，编排器可以与**虚拟基础设施管理器**（**VIM**）（如 OpenStack 和 vCenter）集成，以便管理虚拟机作为网络服务建模的一部分。

+   **基于策略的网络**：在这种类型的自动化中，您描述了网络中所需的内容，系统具有所有详细信息，以便找出如何在底层设备中实现它。这使软件工程师和开发人员能够在网络中实施更改，并在声明性策略中描述其应用程序的需求。

# 网络实验室设置

现在，我们将开始在一个名为 EVE-NG 的流行平台上构建我们的网络实验室。当然，您可以使用物理节点来实现拓扑，但虚拟化环境为我们提供了一个隔离和沙箱环境，可以测试许多不同的配置，还可以灵活地添加/删除节点到/从拓扑中。此外，我们可以对我们的配置进行多个快照，因此可以随时恢复到任何场景。

EVE-NG（以前称为 UNetLab）是网络仿真中最受欢迎的选择之一。它支持来自不同供应商的各种虚拟化节点。还有另一个选择，即 GNS3，但正如我们将在本章和下一章中看到的那样，EVE-NG 提供了许多功能，使其成为网络建模的一个坚实选择。

EVE-NG 有三个版本：社区版、专业版和学习中心。我们将使用社区版，因为它包含了我们在本书中需要的所有功能。

# 准备就绪-安装 EVE-NG

EVE-NG 社区版有两个选项，OVA 和 ISO。第一个选项是使用 OVA，它为您提供了所需的最少安装步骤，前提是您已经拥有 VMware Player/Workstation/Fusion，或 VMware ESXi，或 Red Hat KVM。第二个选项是在没有虚拟化程序的裸机服务器上直接安装它，这次使用 Ubuntu 16.06 LTS 操作系统：

![](img/00044.jpeg)

然而，ISO 选项需要一些 Linux 高级技能来准备机器本身，并将安装存储库导入操作系统。

Oracle VirtualBox 不支持 EVE-NG 所需的硬件加速，因此最好在 VMware 或 KVM 中安装它。

首先，前往[`www.eve-ng.net/index.php/downloads/eve-ng`](http://www.eve-ng.net/index.php/downloads/eve-ng)下载最新版本的 EVE-NG，然后将其导入到您的虚拟化程序中。我为创建的机器分配了 8 GB 内存和四个 vCPU，但您可以为其添加更多资源。在下一节中，我们将看到如何将下载的镜像导入到虚拟化程序并配置每个镜像。

# 在 VMware Workstation 上安装

在接下来的步骤中，我们将把下载的 EVE-NG OVA 镜像导入到 VMware Workstation 中。基于 OVA 的镜像包含描述虚拟机的文件，如硬盘、CPU 和 RAM 值。导入后，您可以修改这些数字：

1.  打开 VMware Workstation，从“文件”中选择“打开”以导入 OVA。

1.  完成导入过程后，右键单击新创建的机器，选择“编辑设置”。

1.  将处理器数量增加到 4 个，内存分配为 8 GB（同样，如果您有资源，可以添加更多，但此设置对于我们的实验足够了）。

1.  确保启用虚拟化 Intel VT-x/EPT 或 AMD-V/RVI 复选框。此选项指示 VMware Workstation 将虚拟化标志传递给客户操作系统（嵌套虚拟化）：

![](img/00045.jpeg)

此外，建议通过向现有硬盘添加额外空间来扩展硬盘，以便有足够的空间来托管来自供应商的多个镜像：

![](img/00046.jpeg)

扩展磁盘后，将出现一条消息，指示操作已成功完成，并且您需要按照一些程序在客户操作系统中将新空间与旧空间合并。幸运的是，我们不需要这样做，因为 EVE-NG 将在系统启动期间将硬盘中发现的任何新空间与旧空间合并：

![](img/00047.jpeg)

# 在 VMware ESXi 上安装

VMware ESXi 是直接在系统上运行的一种类型 1 虚拟化程序的良好示例。有时它们被称为裸机虚拟化程序，并且与类型 2 虚拟化程序（如 VMware Workstation/Fusion 或 VirtualBox）相比，它们提供了许多功能：

1.  打开 vSphere 客户端并连接到您的 ESXi 服务器

1.  从“文件”菜单中，选择“部署 OVF 模板”

1.  输入下载的 OVA 镜像的路径并单击“下一步”：

![](img/00048.jpeg)

1.  接受虚拟化程序建议的所有默认设置，直到您到达最终页面“准备完成”，然后单击“完成”：

![](img/00049.jpeg)

ESXi 将开始在虚拟化程序上部署镜像，稍后您可以更改其设置并为其添加更多资源，就像我们之前在 VMware Workstation 中所做的那样。

# 在 Red Hat KVM 上安装

您需要将下载的 OVA 镜像转换为 KVM 支持的 QCOW2 格式。按照以下步骤将一种格式转换为另一种格式。我们将需要一个名为`qemu-img`的特殊实用程序，该实用程序可在`qemu-utils`软件包内找到：

1.  解压下载的 OVA 文件以提取 VMDK 文件（镜像的硬盘）：

```py
tar -xvf EVE\ Community\ Edition.ova
EVE Community Edition.ovf
EVE Community Edition.vmdk
```

1.  安装`qemu-utils`工具：

```py
sudo apt-get install qemu-utils
```

1.  现在，将 VMDK 转换为 QCOW2。转换可能需要几分钟才能完成：

```py
qemu-img convert -O qcow2 EVE\ Community\ Edition.vmdk eve-ng.qcow
```

最后，我们有自己的准备好在 Red Hat KVM 中托管的`qcow2`文件。打开 KVM 控制台，并从菜单中选择“导入现有磁盘映像”选项：

![](img/00050.jpeg)

然后，选择转换图像的路径并单击“前进”：

![](img/00051.jpeg)

# 访问 EVE-NG

在将镜像导入虚拟化程序并启动它后，您将被要求提供一些信息以完成安装。首先，您将看到 EVE 标志，表示机器已成功导入虚拟化程序，并准备启动引导阶段：

1.  提供将用于 SSH 连接到 EVE 机器的 root 密码。默认情况下，它将是`eve`：

![](img/00052.gif)

1.  提供将在 Linux 内用作名称的主机名：

![](img/00053.gif)

1.  为机器提供一个域名：

![](img/00054.gif)

1.  选择使用静态方法配置网络。这将确保即使在机器重启后，给定的 IP 地址也将是持久的：

![](img/00055.gif)

1.  最后，提供一个从您的网络可达的范围内的静态 IP 地址。此 IP 将用于 SSH 到 EVE 并将供应商镜像上传到存储库：

![](img/00056.gif)

要访问 EVE-NG GUI，您需要打开浏览器并转到`http://<server_ip>`。请注意，`server_IP`是我们在安装步骤中使用的：

![](img/00057.jpeg)GUI 的默认用户名是`admin`，密码是`eve`，而 SSH 的默认用户名是`root`，密码是在安装步骤中提供的。

# 安装 EVE-NG 客户端包

EVE-NG 附带的客户端包允许我们选择在 telnet 或 SSH 到设备时使用哪个应用程序（PuTTY 或 SecureCRT），并设置 Wireshark 以在链接之间进行远程数据包捕获。此外，它还便于在基于 RDP 和 VNC 的镜像上工作。首先，您需要从[`eve-ng.net/index.php/downloads/windows-client-side-pack`](http://eve-ng.net/index.php/downloads/windows-client-side-pack)下载客户端包到您的 PC，然后将文件提取到`C:\Program Files\EVE-NG`：

![](img/00058.gif)

提取的文件包含许多用 Windows 批处理脚本（`.bat`）编写的脚本，用于配置将用于访问 EVE-NG 的机器。您将找到配置默认 Telnet/SSH 客户端的脚本和另一个用于 Wireshark 和 VNC 的脚本。软件源也可在文件夹内找到：

![](img/00059.jpeg)如果您使用 Ubuntu 或 Fedora 等 Linux 桌面，则可以使用 GitHub 上的这个优秀项目来获取客户端包：[`github.com/SmartFinn/eve-ng-integration`](https://github.com/SmartFinn/eve-ng-integration)。

# 将网络图像加载到 EVE-NG 中

从供应商获得的所有网络图像都应上传到`/opt/unetlab/addons/qemu`。EVE-NG 支持基于 QEMU 的图像和动态图像，还支持 iOL（iOS On Linux）。

当您从供应商那里获得图像时，您应该在`/opt/unetlab/addons/qemu`内创建一个目录，并将图像上传到该目录；然后，您应该执行此脚本来修复上传图像的权限：

```py
/opt/unetlab/wrappers/unl_wrapper -a fixpermission
```

# 构建企业网络拓扑

在我们的基本实验室设置中，我们将模拟一个具有四个交换机和一个充当外部网络网关的路由器的企业网络。以下是将用于每个节点的 IP 模式：

| **节点名称** | **IP** |
| --- | --- |
| GW | `10.10.88.110` |
| Switch1 | `10.10.88.111` |
| Switch2 | `10.10.88.112` |
| Switch3 | `10.10.88.113` |
| Switch4 | `10.10.88.114` |

我们的 Python 脚本（或 Ansible 剧本）将托管在连接到每个设备的管理的外部 Windows PC 上。

# 添加新节点

我们将首先选择已经上传到 EVE 的 IOSv 图像，并将四个交换机添加到拓扑。右键单击拓扑中的任何空白处，并从下拉菜单中选择添加新对象，选择添加节点：

![](img/00060.jpeg)

您应该看到两个蓝色的 Cisco 图像，表示它们已成功添加到 EVE-NG 库中的可用图像，并映射到相应的模板。选择 Cisco vIOS L2 以添加 Cisco 交换机：

![](img/00061.jpeg)

增加要添加的节点数到 4，然后点击确定：

![](img/00062.jpeg)

现在，您将看到四个交换机添加到拓扑；再次重复此操作并添加路由器，但这次选择 Cisco vIOS：

![](img/00063.jpeg)

# 连接节点

现在，开始连接节点，当节点离线时，重复每个节点，直到您完成连接拓扑内的所有节点；然后，开始实验：

![](img/00064.gif)

在将 IP 地址和一些自定义形状添加到拓扑后的最终视图如下：

![](img/00065.jpeg)

现在，我们的拓扑已经准备就绪，并且应该加载基本配置。我使用以下片段作为启用 SSH 和 telnet 的任何 Cisco-IOS 设备的配置基础，并配置了用于访问的用户名。请注意，有一些参数被`{{ }}`包围。我们将在下一章讨论它们，当我们使用 Jinja2 模板生成一个黄金配置时，但现在，分别用`hostname`和每个设备的管理 IP 地址替换它们：

```py
hostname {{hostname}}
int gig0/0
  no shutdown
  ip address {{mgmt_ip}} 255.255.255.0

aaa new-model
aaa session-id unique
aaa authentication login default local
aaa authorization exec default local none 

enable password access123
username admin password access123
no ip domain-lookup

lldp run

ip domain-name EnterpriseAutomation.net
ip ssh version 2
ip scp server enable
crypto key generate rsa general-keys modulus 1024

```

# 总结

在本章中，我们了解了当今可用的不同类型的网络自动化，以及为什么我们选择 Python 作为网络自动化中的主要工具。此外，我们学习了如何在不同的 hypervisor 和平台上安装 EVE-NG，如何提供初始配置，以及如何将我们的网络图像添加到图像目录中。然后，我们添加了不同的节点并将它们连接在一起，以创建我们的网络企业实验室。

在下一章中，我们将开始构建我们的 Python 脚本，使用不同的 Python 库（如 telnetlib、Netmiko、Paramiko 和 Pexpect）自动化拓扑中的不同任务。
