# 附录A. 使用Wireshark

在开发网络应用程序时，能够准确查看网络上传输的内容通常是很有用的。也许您的帧存在一些奇怪的问题，您正在尝试发现浏览器的用户代理，或者您想查看IP协议或更低层发生了什么。我们可以使用一类工具叫做**数据包嗅探器**来做到这一点。

# 数据包嗅探器

数据包嗅探器旨在捕获进出计算机的所有网络流量，使我们能够查看我们的程序发送和接收的所有数据包的完整原始内容，以及堆栈上所有协议的所有标头和有效负载。

我们将快速浏览其中一个应用程序。它不仅为我们提供了一个非常有用的网络编程调试工具，还直接展示了网络流量的结构，并让您更好地了解分层和封装的概念。

在我们开始之前，有一个小小的警告；如果您在不属于自己的网络上使用计算机，比如在您的工作场所或学习场所，您应该在运行数据包嗅探器之前获得网络管理员的许可。在使用网络集线器而不是交换机的网络上，嗅探器可能会捕获发送到其他计算机的数据。此外，运行数据包嗅探器可能违反您的网络使用政策。即使不违反，数据包嗅探器也是强大的网络监控工具，管理员通常希望在使用时知道。

如果这变得困难，不要惊慌！本书在任何时候都不依赖于使用数据包嗅探器；我们只是认为在编程网络时会发现它们很方便。

# Wireshark

我们要看的程序叫做**Wireshark**。它是一个支持解释广泛的网络协议的开源数据包嗅探器。

## 安装

对于Windows和Linux，Wireshark可以从[http://www.wireshark.org](http://www.wireshark.org)下载。在Debian，Ubuntu，RHEL，CentOS和Fedora上，它作为`wireshark`软件包可用。

您需要root或管理员访问权限才能安装此软件。在Windows上，如果要求安装或更新`WinPcap`库，请确保这样做，并在提示时允许它在启动时启动`WinPcap`驱动程序。

在Debian和Ubuntu上，您需要配置Wireshark以允许常规用户运行捕获。运行以下命令：

```py
**$ sudo dpkg-reconfigure wireshark-common**

```

对于`Should non-superusers be able to capture packets?`选择`Yes`。请注意，这并不会自动允许所有非超级用户使用Wireshark，他们仍然需要被添加到`wireshark`组。例如，现在为您自己的用户执行此操作：

```py
**$ sudo usermod -aG wireshark myuser**

```

您可能需要注销并重新登录才能生效，或者甚至需要重新启动。对于其他Linux发行版，请查看其文档，或者在Wireshark的wiki上有关于分配这些权限的说明，网址是[http://wiki.wireshark.org/CaptureSetup/CapturePrivileges](http://wiki.wireshark.org/CaptureSetup/CapturePrivileges)。

如果在任何时候遇到问题，您可以在[http://wiki.wireshark.org/CaptureSetup](http://wiki.wireshark.org/CaptureSetup)的wiki上获得有关安装的更多帮助。

配置完成后，在Linux上只需在`X`会话中运行`wireshark`即可启动图形界面。

## 捕获一些数据包

安装并运行Wireshark后，您将看到一个窗口，类似于这样：

![捕获一些数据包](graphics/6008OS_Appendix_01.jpg)

数据包嗅探通常分为两个步骤：首先，我们运行一个流量捕获会话，然后分析捕获的流量。在捕获过程中，Wireshark向操作系统请求其处理的所有网络流量的副本，然后Wireshark将其保存在缓冲区中供我们分析。Wireshark提供了工具，让我们过滤捕获的数据，以便我们只处理我们想要的数据流，并深入每个数据包以查看标头数据和有效载荷。

因此，首先，我们需要选择要捕获流量的接口。我们可以看到**开始**按钮下面有一个接口列表。Wireshark捕获我们选择的所有接口上传输的所有网络流量；这通常意味着我们最终会捕获许多我们实际上不感兴趣的数据。为了减少这种噪音，最好尽可能少地捕获接口，理想情况下只捕获一个接口。

我们将使用第一个RFC下载器，来自[第1章](ch01.html "第1章。网络编程和Python")*网络编程和Python*，`RFC_downloader.py`，生成一些要分析的网络流量。由于此程序与互联网上的主机通信，我们希望捕获提供我们互联网连接的网络接口。

如果您不确定哪个接口是您的互联网接口，那么点击上面的**开始**按钮旁边的**接口列表**按钮，以打开窗口，如下面的屏幕截图所示：

![捕获一些数据包](graphics/6008OS_Appendix_02.jpg)

在对话框的右侧，您可以看到自打开窗口以来通过每个接口的数据包数量的实时计数。如果没有太多活动，您可以通过浏览网站来生成一些互联网流量。数据包计数上升最快的接口将是互联网接口（在Linux上忽略`any`接口）。记下接口的名称并关闭窗口。

网络接口可以以两种模式之一捕获数据包：混杂模式和非混杂模式。在混杂模式下，接口将把它接收到的所有流量传递给嗅探器，即使这些流量并非是发送到我们计算机的流量。在非混杂模式下，接口会过滤掉任何不是发送给我们计算机的流量。除非您有非常特定的原因，通常最好以非混杂模式运行，因为这减少了我们需要手动过滤的多余流量。Wireshark默认启用混杂模式。要禁用，进入**捕获** | **选项...**，确保未选中“在所有接口上使用混杂模式”。然后检查选项窗口顶部的接口列表中的“Prom Mode”列，并确保您要捕获的接口的状态为已禁用。完成后，关闭选项窗口返回到主屏幕。

从主屏幕上**开始**按钮下方的接口列表中选择您的互联网接口，并点击**开始**开始捕获。一会儿后，我们应该会看到一些数据包进来：

![捕获一些数据包](graphics/6008OS_Appendix_03.jpg)

在Wireshark捕获数据包时，让我们生成一些我们有兴趣分析的流量。在终端中运行`RFC_downloader.py` RFC下载程序以下载RFC 2324：

```py
**$ python3 RFC_downloader.py 2324**
**...**
**Network Working Group                                     L. Masinter**
**Request for Comments: 2324                               1 April 1998**
**Category: Informational**
**...**

```

下载完成后，返回到Wireshark，并通过工具栏中的**停止**按钮停止捕获。如果捕获出现问题，不要担心，我们可以再试一次；只需停止捕获，然后在工具栏中点击**开始新的实时捕获**按钮，并在提示时不保存对先前捕获的更改。运行`RFC_downloader.py`。一旦您有包含RFC下载器流量的捕获，让我们仔细看一下。

在前面的截图中可以看到，Wireshark捕获屏幕分为三个部分。顶部部分列出了捕获的数据包，每行一个数据包，并为每个数据包提供基本信息，例如源和目的地地址，以及数据包包含数据的最高层协议的名称。

中间部分包含所选数据包中存在的协议的详细信息。顶部行相当于网络堆栈中的第1层，随后的行对应于更高的层。

底部部分包含整个捕获数据包的原始列表。这被分为三个主要的垂直区域。左侧第一列中的数字是从数据包开头的十六进制字节偏移量。中间部分包括两列每列8个十六进制数字；这部分显示数据包中的每个字节作为十六进制整数。右侧部分包括两列ASCII字符，是数据包中字节的ASCII表示。在这里使用点，当一个字节值映射到一个不可打印的字符时。

## 过滤

让我们看看我们的下载程序生成了哪些数据包。在捕获中可能有相当多额外的网络数据，所以首先，我们需要将其过滤掉。

Wireshark允许我们使用其支持的任何协议的任何属性进行过滤。要进行过滤，我们使用工具栏下方的过滤框。Wireshark有一个完整的过滤语言，您可以在帮助系统中进行调查。现在，我们只是要做一些基本的查询来找到我们的数据包。在过滤框中输入`http`，然后单击**应用**按钮。这将限制显示的数据包只涉及HTTP协议，如下图所示：

![过滤](graphics/6008OS_Appendix_04.jpg)

即使在捕获会话期间您故意生成的唯一HTTP流量是通过下载程序，我们可能会看到更多的HTTP数据包。这是因为一些程序，例如文件云存储客户端，经常通过HTTP在后台与其服务进行通信。此外，Wireshark目前将SSDP协议数据包识别为HTTP，因为SSDP源自HTTP。

不过没关系，我们可以优化我们的过滤器。我们下载器数据包的唯一标识特征是我们通信的服务器，[www.ietf.org](http://www.ietf.org)。如果我们看一下数据包列表，你会发现捕获的数据包的源和目的地地址是IP地址，所以在编写新的过滤器之前，我们需要找出[www.ietf.org](http://www.ietf.org)的IP地址。

获取主机名的IP地址称为**名称解析**，这正是DNS设计的任务。我们可以使用几种机制与DNS交互。在Linux和Windows上，我们可以使用`nslookup`命令行工具。运行以下命令：

```py
**$ nslookup www.ietf.org**
**Server:        127.0.1.1**
**Address:       127.0.1.1#53**

**Non Authoritative answer:**
**www.ietf.org    canonical name = www.ietf.org.cdn.cloudflare-** 
 **dnssec.net.**
**Name:   www.ietf.org.cdn.cloudflare-dnssec.net**
**Address: 104.20.1.85**
**Name:   www.ietf.org.cdn.cloudflare-dnssec.net**
**Address: 104.20.0.85**

```

输出表明[www.ietf.org](http://www.ietf.org/)实际上托管在两个IP地址上：`104.20.1.85`和`104.20.0.85`。随着越来越多的网站部署负载均衡和内容传送网络来分散服务器的工作负载，这种情况变得越来越频繁。

快速查看我们捕获的HTTP数据包列表可能会让我们看到我们最终连接到的服务器。在前面的示例中，它是`104.20.0.85`。但是，为了确保，我们可以过滤这两个IP地址。

请注意，`nslookup`可能返回与前面示例中显示的IP地址不同的IP地址。Web服务可以因各种原因更改其服务器的IP地址。

现在，我们可以过滤[www.ietf.org](http://www.ietf.org/)。使用刚刚解析的IP地址，输入以下新查询到过滤框中：

```py
http and (ip.addr == 104.20.1.85 or ip.addr == 104.20.0.85)
```

再次单击**应用**按钮。此查询添加了额外的条件，即除了涉及HTTP协议外，数据包必须具有IP源地址或目的地址为`104.20.1.85`或`104.20.0.85`。

`ip.addr`语法是过滤协议属性的典型示例。还有很多其他的。例如，如果我们只想按源地址过滤而不是源地址和目的地址，我们可以使用以下命令：

```py
http and (ip.src == 104.20.1.85 or ip.src == 104.20.0.85)
```

要探索所有可用的协议及其属性，请单击过滤框右侧的**表达式...**按钮。在出现的窗口的左侧窗格中，我们可以看到列出的所有协议，并且可以通过单击相应的三角形或**+**符号来展开其中一个，这将显示其属性。在此窗口中，IP被列为`IPv4`。

## 检查数据包

回到我们的RFC下载器数据包，如果表达式窗口打开了，让我们关闭它，然后将注意力转向主窗口。应用了`http and (ip.addr == 104.20.1.85 or ip.addr == 104.20.0.85)`过滤器后，我们应该在屏幕顶部的列表中看到两个数据包：

![检查数据包](graphics/6008OS_Appendix_05.jpg)

第一个是`urlopen()`发送到服务器的HTTP请求，第二个是服务器的HTTP响应。

单击第一个数据包以选择它，然后将注意力转向窗口的中间部分。我们可以看到五行信息。每一行对应网络堆栈中的一层和该层中使用的协议。在屏幕底部的原始数据包列表上保持关注，单击中间部分的不同行。您会看到突出显示不同区域的原始数据包列表。突出显示的区域是您单击的协议相关的原始数据包的部分。对于第一层（以**Frame**开头的行），它会突出显示整个数据包，因为整个数据包是通过电线发送的。对于最后一层，**超文本传输协议**，它会突出显示数据包的部分，即HTTP请求，如前面的示例所示。对于中间的层，它只会突出显示该协议封装数据包的标头。

我们可以通过单击中间部分协议行左侧的三角形或**+**符号来查看每个封装数据包的标头数据。如果我们对**超文本传输协议**行这样做，我们会得到类似于这样的东西：

![检查数据包](graphics/6008OS_Appendix_06.jpg)

我们的请求中的`HTTP`标头已被Wireshark解释并拆分，以使其更易读。您可以以相同的方式探索其他协议的数据。

让我们检查我们捕获的第二个数据包，即HTTP响应。现在在窗口的顶部部分单击它：

![检查数据包](graphics/6008OS_Appendix_07.jpg)

您会注意到中间部分的这个数据包有一些额外的行。指示重新组装的TCP段的行表明HTTP响应实际上足够大，可以跨四个TCP数据包进行分割。Wireshark识别到这一点，并通过组合相关的TCP数据包重新组装了完整的HTTP数据包，因此当我们单击**超文本传输协议**行时，我们会看到整个HTTP数据包。

### 注意

如果您没有看到这个选项，您可能需要在选项菜单中打开它。转到**编辑** | **首选项...**以打开首选项窗口，然后在屏幕左侧的列表中展开**协议**，并向下滚动找到**HTTP**。确保检查了涉及跨多个TCP段的两个选项。

最后，**基于行的文本数据**行向我们显示了响应内容的媒体类型（在[第2章](ch02.html "第2章。HTTP和与网络工作")中描述，*HTTP和与网络工作*），展开该行会显示响应正文的文本数据。

## 一个多功能工具

正如您在浏览菜单时可能会注意到的那样，Wireshark是一个功能非常丰富的网络分析器，我们甚至还没有完全发掘出它的全部功能。我鼓励您在阅读本书时随时使用它，并且在您希望更仔细地查看网络上传输或接收的数据时使用它。
